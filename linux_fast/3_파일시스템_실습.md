
## 디스크별 / 디렉토리별 스토리지 사용량 조회

![[Pasted image 20221018211407.png]]

### 디스크
현재 디렉토리가 포함된 디스크/파티션 공간의 남은 용량 확인 : `df -h .`

### 디렉토리
`du /etc` : 하위 디렉토리 까지 사용량
`du -a .` : 파일크기가 0인 것 포함
`du -s` : 지정한 디렉토리 내에 존재하는 파일 및 디렉토리의 합
`du -d 1` : 1 depth 디렉토리까지 용량확인


특정 디렉토리 조회 : `du -sh 경로`
![[Pasted image 20221018211812.png]]

Depth1 조회 : `du -h -d 1 /home/eumdengs`
홈 디렉토리 사용량 조회 결과 크기 역순으로 정렬
`du -h -d 1 /home/eumdengs | sort -h -r`
![[Pasted image 20221018211842.png]]


### 문제
**디스크를 가장 많이 사용하는 디렉토리 정보**
루트 디렉토리의 사용량 조회결과를 크기 역순으로 정렬

```
du -h -d 1 / 2> /dev/null | sort -h -r | head -n 20
du -h -d 2 /var 2> /dev/null | sort -h -r | head -n 20
```

![[Pasted image 20221018212036.png]]

`2> /dev/null` : 표준에러를 redirect -> `/dev/null`

![[Pasted image 20221018212139.png]]



---


## 기존 시스템에 디스크 볼륨 추가

![[Pasted image 20221018212408.png]]

EBS -> 가용영역에 종속적인 서비스(EC2와 동일하게 설정)
생성 후 -> 작업 -> `사용가능` -> 볼륨 연결 -> 인스턴스 설정 -> 디바이스 이름 설정 `/dev/sdf`
인스턴스의 스토리지 탭에 생성이 됨

### linux 실습
`lsblk` : 블록스토리지 정보 확인
`sudo file -s /dev/sdf` : 파일시스템이 있는지 확인
- data : 파일시스템이 없는 경우
- ext4

파일시스템 생성
`sudo mkfs -t ext4 /dev/sdf`
`sudo file -s /dev/sdf`

마운트 디렉토리 생성
`sudo mkdir /data`
`sudo mount /dev/sdf /data`

파일시스템 테이블 수정
`sudo cp /etc/fstab /etc/fstab.orig`
`sudo blkid`
![[Pasted image 20221018213150.png]]

`sudo vi /etc/fstab`
nofail : 마운트가 안되도 fail X
![[Pasted image 20221018213237.png]]

테스트
`sudo umount /data`
`mount` : 해당 마운트 정보가 없다

`sudo mount -a` : 전부 마운트
`df -h`

역순으로 진행하면 제거
볼륨 분리 ->강제분리 -> 삭제


---


## LVM 디스크 관리

![[Pasted image 20221018214056.png]]


### 구성도
![[Pasted image 20221018214344.png]]



### 확장 가능한 디스크 볼륨 구성
EBS 생성 -> 볼륨 추가 -> 볼륨 연결

```
lsblk
sudo file -s /dev/xvdf
# /dev/xvdf: data          <- 파일시스템이 없는 경우
# sudo file -s /dev/xvda1  <- 파일시스템이 있는 경우 
```

물리 볼륨 생성 및 확인
```
sudo pvcreate /dev/xvdf
sudo pvs
```

![[Pasted image 20221018214723.png]]

볼륨 그룹 생성 및 볼륨 그룹에 물리 볼륨 추가
```
sudo vgcreate Data /dev/xvdf
sudo vgs
```

![[Pasted image 20221018214752.png]]

논리 볼륨 생성 및 마운트
```
sudo lvcreate -n data1 -L 9G Data
sudo lvs
sudo mkdir /data1
sudo mkfs -t ext4 /dev/Data/data1
lsblk -f
sudo mount /dev/Data/data1 /data1
```

![[Pasted image 20221018214839.png]]

![[Pasted image 20221018215004.png]]

![[Pasted image 20221018215030.png]]

파일시스템 테이블 수정 `fstab` 수정
```
/dev/Data/data1 /data1  ext4     defaults,nofail   0   2
```




### 추가적인 디스크 볼륨 구성
EBS -> ... -> 볼륨 연결

EC2의 디바이스 상태 및 파일 시스템 존재 여부 확인
```
lsblk
sudo file -s /dev/xvdg
# /dev/xvdg: data          <- 파일시스템이 없는 경우
```

물리 볼륨을 생성 및 확인
```
sudo pvcreate /dev/xvdg
sudo pvs
```

볼륨 그룹 확장
```
sudo vgextend Data /dev/xvdg
sudo vgs
```

논리볼륨 확장
```
sudo lvextend -L +20G /dev/Data/data1
sudo resize2fs /dev/Data/data1
```




### 삭제 및 마운트 해제

파일시스템 삭제 및 마운트 해제
```
vim /etc/fstab
sudo umount /data1
```

논리볼륨 삭제
```
sudo lvremove /dev/Data/data1
```

볼륨그룹 삭제
```
sudo vgremove Data
```

물리 볼륨 삭제
```
sudo pvremove /dev/xvdf
sudo pvremove /dev/xvdg
```

AWS에서 EBS 볼륨 연결 해제 및 삭제 진행